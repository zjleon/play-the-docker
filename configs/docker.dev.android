FROM ubuntu:15.10
FROM java:8
FROM node:6.2.2-wheezy

# install maven dependencies downloader
WORKDIR /opt
ARG MAVEN_VERSION=3.3.9
RUN curl -LO http://mirrors.cnnic.cn/apache/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz && \
    tar xzf apache-maven-${MAVEN_VERSION}-bin.tar.gz && \
    rm -f apache-maven-${MAVEN_VERSION}-bin.tar.gz
ENV PATH ${PATH}:/opt/apache-maven-${MAVEN_VERSION}/bin

# install gradle
WORKDIR /usr/bin
ARG GRADLE_VERSION=3.1
RUN curl -LO https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip && \
  unzip gradle-${GRADLE_VERSION}-bin.zip && \
  ln -s gradle-${GRADLE_VERSION} gradle && \
  rm gradle-${GRADLE_VERSION}-bin.zip
ENV GRADLE_HOME="/usr/bin/gradle"
ENV PATH $PATH:$GRADLE_HOME/bin
# enable gradle deamon for faster build
ENV GRADLE_OPTS="-Dorg.gradle.daemon=true"

# install android sdk
WORKDIR /opt
ARG ANDROID_SDK_VERSION=r24.4.1
RUN dpkg --add-architecture i386 && \
    apt-get update && \
    apt-get install -y --force-yes --no-install-recommends \
      expect \
      libncurses5:i386 libstdc++6:i386 zlib1g:i386 \
      usbutils
#RUN curl -LO http://dl.google.com/android/android-sdk_${ANDROID_SDK_VERSION}-linux.tgz && \
RUN curl -LO https://dl.google.com/android/android-sdk_${ANDROID_SDK_VERSION}-linux.tgz && \
    tar xzf android-sdk_${ANDROID_SDK_VERSION}-linux.tgz && \
    rm -f android-sdk_${ANDROID_SDK_VERSION}-linux.tgz
ENV ANDROID_HOME /opt/android-sdk-linux
ENV PATH ${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/platform-tools
COPY ./scripts/android.dev.agree_to_install_dependencies.sh ./agree.sh
RUN ["chmod", "+x", "agree.sh"]
# install android tools
RUN ["./agree.sh", "android update sdk --filter tools --no-ui --force -a"]
RUN ["./agree.sh", "android update sdk --filter platform-tools --no-ui --force -a"]
RUN ["./agree.sh", "android update sdk --filter \"android-23\" --no-ui --force -a"]
RUN ["./agree.sh", "android update sdk --filter \"build-tools-23.0.3\" --no-ui --force -a"]
RUN ["./agree.sh", "android update sdk --filter \"extra-android-support\" --no-ui --force -a"]
RUN ["./agree.sh", "android update sdk --filter \"extra-android-m2repository\" --no-ui --force -a"]
RUN ["./agree.sh", "android update sdk --filter \"extra-google-m2repository\" --no-ui --force -a"]

# config adb connection
COPY ./configs/51-android.rules /etc/udev/rules.d/51-android.rules
EXPOSE 5037

# pre-install all project dependencies, via pom.xml
WORKDIR /tmp
COPY ./configs/maven.dev.android_dependencies.xml ./pom.xml
# RUN mvn dependency:go-offline
RUN ["mvn", "dependency:resolve", "-Dclassifier=sources"]

# install react-native packages to /tmp, copy to /app when run time

# do some clean up
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/* \
    /tmp/* \
    /var/tmp/* \
    /opt/apache-maven-${MAVEN_VERSION} \
    /opt/agree.sh

CMD ["bash"]
