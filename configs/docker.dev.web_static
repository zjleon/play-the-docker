FROM ubuntu:15.10

RUN apt-get update && \
    apt-get install -y --force-yes --no-install-recommends \
    ssh \
    git \
    xz-utils
    # curl

# install node
WORKDIR /opt
ENV NODE_VERSION=6.9.1
COPY ./resources/node-v${NODE_VERSION}-linux-x64.tar.xz ./node.tar.xz
RUN tar xJf node.tar.xz --directory /opt && \
    rm -f node.tar.xz
ENV PATH ${PATH}:/opt/node-v${NODE_VERSION}-linux-x64/bin

# install yarn
COPY ./resources/yarn-v0.21.3.tar.gz ./yarn.tar.gz
RUN mkdir yarn && \
    tar zxf yarn.tar.gz --directory /opt/yarn --strip-components=1 &&  \
    rm -f yarn.tar.gz
ENV PATH ${PATH}:/opt/yarn/bin

# install tini
COPY ./resources/tini /tini
RUN chmod +x /tini

ARG PROJECT=web_static

# add ssh key before yarn install
# RUN mkdir /root/.ssh/
# ADD ./configs/id_rsa /root/.ssh/id_rsa
# RUN touch /root/.ssh/known_hosts && \
#     ssh-keyscan bitbucket.org >> /root/.ssh/known_hosts && \
#     ssh-keyscan github.com >> ~/.ssh/known_hosts && \
#     echo "Host github.com\n\tUser git\n" >> /root/.ssh/config

# pre-install node resources
WORKDIR /node_resources
COPY ./src/${PROJECT}/package.json ./package.json
COPY ./src/${PROJECT}/.yarnrc ./.yarnrc
RUN yarn install && \
    rm -f package.json
EXPOSE 8070
EXPOSE 8080
EXPOSE 8081
ENV NODE_ENV=development

# execute initialize script
WORKDIR /app
ENTRYPOINT ["/tini", "--"]
# initial.sh will be mounted to client disk
CMD ["/bin/bash", "./initial.sh"]
